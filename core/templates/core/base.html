<!DOCTYPE html>
{% load static %}
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ config.site_name }} | Hyper-Advanced Digital Ecosystems{% endblock %}</title>

    {% if config.favicon %}
    <link rel="icon" type="image/png" href="{{ config.favicon.url }}">
    {% else %}
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
    {% endif %}

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap"
        rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        alien: {
                            DEFAULT: '#00ff41',
                            dim: '#008F11',
                            glow: '#39ff14',
                            dark: '#020202',
                            panel: 'rgba(10, 20, 10, 0.95)'
                        }
                    },
                    fontFamily: {
                        orbitron: ['Orbitron', 'sans-serif'],
                        rajdhani: ['Rajdhani', 'sans-serif'],
                        mono: ['Share Tech Mono', 'monospace'],
                    },
                    backgroundImage: {
                        'grid-pattern': "linear-gradient(to right, #00ff4105 1px, transparent 1px), linear-gradient(to bottom, #00ff4105 1px, transparent 1px)",
                    },
                    cursor: { 'none': 'none' },
                    screens: {
                        'xl': '1280px', // Explicit breakpoint for nav switch
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #020202;
            color: #e0ffe0;
            overflow-x: hidden;
            cursor: none !important;
        }

        ::-webkit-scrollbar {
            width: 6px;
            background: #000;
        }

        ::-webkit-scrollbar-thumb {
            background: #00ff41;
            box-shadow: 0 0 10px #00ff41;
        }

        .hud-corner {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid #00ff41;
            transition: all 0.3s;
        }

        .hud-tl {
            top: 0;
            left: 0;
            border-right: 0;
            border-bottom: 0;
        }

        .hud-tr {
            top: 0;
            right: 0;
            border-left: 0;
            border-bottom: 0;
        }

        .hud-bl {
            bottom: 0;
            left: 0;
            border-right: 0;
            border-top: 0;
        }

        .hud-br {
            bottom: 0;
            right: 0;
            border-left: 0;
            border-top: 0;
        }

        .alien-card:hover .hud-corner {
            width: 100%;
            height: 100%;
            opacity: 0.1;
            background: #00ff41;
        }

        /* Mega Menu Animation & Positioning */
        .mega-menu {
            display: none;
            opacity: 0;
            transform: translateY(-10px) translateX(-50%);
            /* Centering logic */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            left: 50%;
            /* Anchor center */
        }

        .group:hover .mega-menu {
            display: block;
            opacity: 1;
            transform: translateY(0) translateX(-50%);
            pointer-events: auto;
        }

        .sci-grid {
            background-size: 40px 40px;
            mask-image: radial-gradient(circle at center, black, transparent 80%);
        }

        #cursor-ship {
            position: fixed;
            top: 0;
            left: 0;
            width: 48px;
            height: 48px;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -50%);
            transition: transform 0.08s ease-out;
            mix-blend-mode: exclusion;
            filter: drop-shadow(0 0 8px rgba(0, 255, 65, 0.6));
        }

        #trail-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9998;
        }

        .decrypt-effect {
            display: inline-block;
        }

        /* Mobile Menu Transitions */
        #mobile-menu {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }

        .mobile-submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .mobile-submenu.open {
            max-height: 500px;
        }

        /* LENIS SMOOTH SCROLL */
        html.lenis,
        html.lenis body {
            height: auto;
        }

        .lenis.lenis-smooth {
            scroll-behavior: auto !important;
        }

        .lenis.lenis-smooth [data-lenis-prevent] {
            overscroll-behavior: contain;
        }

        .lenis.lenis-stopped {
            overflow: hidden;
        }

        .lenis.lenis-scrolling iframe {
            pointer-events: none;
        }
    </style>
    {% block extra_head %}{% endblock %}
</head>

<body class="font-rajdhani selection:bg-alien selection:text-black">

    <div id="cursor-ship">
        <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 13C10 9 13 6 16 6C19 6 22 9 22 13" fill="#00ff41" fill-opacity="0.3" stroke="#00ff41"
                stroke-width="1" />
            <ellipse cx="16" cy="16" rx="15" ry="5" fill="#020202" stroke="#00ff41" stroke-width="1.5" />
            <path d="M4 17Q16 23 28 17" stroke="#00ff41" stroke-width="1" stroke-linecap="round" />
            <circle cx="7" cy="18" r="1" fill="#fff" class="animate-pulse" />
            <circle cx="16" cy="20" r="1.5" fill="#fff" />
            <circle cx="25" cy="18" r="1" fill="#fff" class="animate-pulse" />
            <ellipse cx="16" cy="21" rx="4" ry="1.5" fill="#00ff41" fill-opacity="0.8" />
        </svg>
    </div>

    <canvas id="trail-canvas"></canvas>
    <div class="fixed inset-0 bg-grid-pattern sci-grid z-[-1] opacity-20"></div>

    <nav class="fixed w-full z-50 top-0 bg-alien-dark/90 backdrop-blur-xl border-b border-alien/20">
        <div class="max-w-[1920px] mx-auto px-6">
            <div class="flex items-center justify-between h-20">
                <a href="{% url 'index' %}" class="flex items-center gap-3 group cursor-pointer relative z-50">
                    {% if config.logo %}
                    <img src="{{ config.logo.url }}" alt="{{ config.site_name }}" class="h-12 w-auto">
                    {% else %}
                    <i data-lucide="zap" class="h-8 w-8 text-alien group-hover:animate-pulse"></i>
                    {% endif %}
                    <span class="font-orbitron font-bold text-2xl tracking-wider text-white">
                        {{ config.site_name|default:"ALIENHOUSE" }}</span>
                </a>

                <div class="hidden xl:flex items-center h-full">
                    <div class="flex h-full relative">
                        <div
                            class="group relative h-full flex items-center px-6 cursor-pointer border-l border-alien/5 hover:bg-alien/5 transition-colors">
                            <span
                                class="text-gray-300 group-hover:text-alien font-orbitron text-sm tracking-widest flex items-center gap-2">
                                COMPANY <i data-lucide="chevron-down"
                                    class="w-3 h-3 transition-transform group-hover:rotate-180"></i>
                            </span>
                            <div
                                class="mega-menu absolute top-20 w-[400px] bg-alien-dark border border-alien/30 p-8 shadow-[0_20px_50px_rgba(0,255,65,0.1)]">
                                <ul class="space-y-2 text-sm text-gray-400 font-mono">
                                    {% for page in company_pages %}
                                    <li
                                        class="hover:text-white hover:translate-x-2 transition-transform cursor-pointer">
                                        <a href="{{ page.get_absolute_url }}">{{ page.title }}</a>
                                    </li>
                                    {% empty %}
                                    <li class="text-gray-500">No company pages found</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>

                        <div
                            class="group relative h-full flex items-center px-6 cursor-pointer border-l border-alien/5 hover:bg-alien/5 transition-colors">
                            <span
                                class="text-gray-300 group-hover:text-alien font-orbitron text-sm tracking-widest flex items-center gap-2">
                                SERVICES <i data-lucide="chevron-down"
                                    class="w-3 h-3 transition-transform group-hover:rotate-180"></i>
                            </span>

                            <div
                                class="mega-menu absolute top-20 w-[900px] max-w-[95vw] bg-alien-dark/95 backdrop-blur-xl border border-alien/30 shadow-[0_20px_50px_rgba(0,255,65,0.15)] overflow-hidden">
                                <div
                                    class="h-1 w-full bg-gradient-to-r from-transparent via-alien to-transparent opacity-50">
                                </div>

                                <div class="max-h-[60vh] overflow-y-auto p-8">

                                    <div class="grid grid-cols-3 gap-6">
                                        {% for svc in all_services %}
                                        <div class="relative group/item">
                                            <a href="{% url 'service_detail' svc.slug %}"
                                                class="flex items-center gap-3 mb-3 pb-2 border-b border-white/10 group-hover/item:border-alien/50 transition-colors">
                                                <div
                                                    class="p-1.5 rounded bg-white/5 text-alien group-hover/item:bg-alien group-hover/item:text-black transition-all duration-300">
                                                    <i data-lucide="{{ svc.icon|default:'cpu' }}" class="w-5 h-5"></i>
                                                </div>
                                                <span
                                                    class="font-orbitron font-bold text-white tracking-wide group-hover/item:text-alien transition-colors text-sm">
                                                    {{ svc.name }}</span>
                                            </a>

                                            {% if svc.sub_services.all %}
                                            <ul class="space-y-1.5 ml-11 border-l border-white/5 pl-4">
                                                {% for sub in svc.sub_services.all %}
                                                {% if sub.is_active %}
                                                <li
                                                    class="flex items-center gap-2 text-xs font-mono text-gray-500 hover:text-white transition-colors cursor-crosshair">
                                                    <span class="text-alien opacity-50">></span> {{ sub.name }}
                                                </li>
                                                {% endif %}
                                                {% endfor %}
                                            </ul>
                                            {% else %}
                                            <p
                                                class="ml-11 text-[10px] text-gray-600 font-mono uppercase tracking-widest">
                                                // No Sub-routines</p>
                                            {% endif %}
                                        </div>
                                        {% empty %}
                                        <div class="col-span-3 text-center py-10">
                                            <i data-lucide="wifi-off" class="w-8 h-8 text-red-500 mx-auto mb-2"></i>
                                            <p class="text-red-500 font-mono">SYSTEM OFFLINE: No Services Deployed</p>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <a href="#rnd"
                            class="group h-full flex items-center px-6 cursor-pointer border-l border-alien/5 hover:bg-alien/5 transition-colors text-gray-300 hover:text-alien font-orbitron text-sm tracking-widest">
                            LABS / R&D
                        </a>

                        <div class="flex items-center ml-6">
                            <a href="#contact"
                                class="relative px-6 py-2 bg-alien text-black font-orbitron font-bold text-sm tracking-widest hover:bg-white transition-colors">
                                CONTACT
                            </a>
                        </div>
                    </div>
                </div>

                <button id="mobile-menu-btn" class="xl:hidden text-alien hover:text-white transition-colors z-50 p-2">
                    <i data-lucide="menu" class="w-8 h-8"></i>
                </button>
            </div>
        </div>
    </nav>

    <div id="mobile-menu"
        class="fixed inset-0 z-40 bg-alien-dark/95 backdrop-blur-2xl translate-x-full pt-24 px-6 overflow-y-auto">
        <div class="flex flex-col space-y-6">

            <div class="border-b border-alien/20 pb-4">
                <button onclick="toggleMobileSubmenu('mobile-company')"
                    class="flex items-center justify-between w-full text-white font-orbitron text-lg tracking-widest mb-2">
                    COMPANY <i data-lucide="chevron-down" class="w-5 h-5 text-alien"></i>
                </button>
                <div id="mobile-company" class="mobile-submenu pl-4 space-y-3">
                    {% for page in company_pages %}
                    <a href="{{ page.get_absolute_url }}"
                        class="block text-gray-400 font-mono text-sm hover:text-alien py-1">> {{ page.title }}</a>
                    {% empty %}
                    <span class="text-gray-600 font-mono text-xs">// No Pages</span>
                    {% endfor %}
                </div>
            </div>

            <div class="border-b border-alien/20 pb-4">
                <button onclick="toggleMobileSubmenu('mobile-services')"
                    class="flex items-center justify-between w-full text-white font-orbitron text-lg tracking-widest mb-2">
                    SERVICES <i data-lucide="chevron-down" class="w-5 h-5 text-alien"></i>
                </button>
                <div id="mobile-services" class="mobile-submenu pl-4 space-y-4 pt-2">
                    {% for svc in all_services %}
                    <div class="mb-3">
                        <a href="{% url 'service_detail' svc.slug %}"
                            class="flex items-center gap-2 text-alien font-bold mb-1">
                            <i data-lucide="{{ svc.icon|default:'cpu' }}" class="w-4 h-4"></i> {{ svc.name }}
                        </a>
                        {% if svc.sub_services.all %}
                        <div class="pl-6 space-y-2 border-l border-white/10 ml-2">
                            {% for sub in svc.sub_services.all %}
                            {% if sub.is_active %}
                            <div class="text-gray-500 text-xs font-mono">{{ sub.name }}</div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <a href="#rnd" class="text-white font-orbitron text-lg tracking-widest border-b border-alien/20 pb-4 block">
                LABS / R&D
            </a>

            <a href="#contact"
                class="block text-center w-full py-3 bg-alien text-black font-orbitron font-bold tracking-widest mt-4">
                INITIATE CONTACT
            </a>

            <button onclick="closeMobileMenu()" class="absolute top-6 right-6 text-gray-500 hover:text-white">
                <i data-lucide="x" class="w-8 h-8"></i>
            </button>
        </div>
    </div>

    <main>
        {% block content %}{% endblock %}
    </main>

    <footer class="bg-[#050505] border-t border-alien/20 pt-20 pb-10 font-rajdhani text-sm relative z-10">
        <div class="max-w-[1920px] mx-auto px-8">
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-12 mb-16">
                <div>
                    <h4 class="text-white font-bold mb-6 text-lg">Capabilities</h4>
                    <ul class="space-y-3 text-gray-500 font-mono">
                        {% for cap in all_services %}
                        <li class="hover:text-alien cursor-pointer">{{ cap.name }}</li>
                        {% empty %}
                        <li class="text-gray-600">No capabilities listed</li>
                        {% endfor %}
                    </ul>
                </div>

                <div>
                    <h4 class="text-white font-bold mb-6 text-lg">Connect</h4>
                    <div class="flex space-x-4 mb-8">
                        {% for contact in contacts %}
                        <a href="{{ contact.get_link }}" target="_blank"
                            class="w-10 h-10 rounded border border-gray-700 flex items-center justify-center text-gray-400 hover:border-alien hover:text-alien hover:bg-alien/10 transition-all">
                            <i data-lucide="{{ contact.contact_type }}"></i>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="border-t border-gray-900 pt-8 flex justify-between items-center text-xs text-gray-600">
                <p>Copyright Â© 2025 {{ config.site_name }}. All Systems Nominal.</p>
            </div>
        </div>
    </footer>

    <script>
        lucide.createIcons();

        // --- THREE.JS GLOBE AND PLANETS ---
        const initThreeJS = () => {
            const container = document.getElementById('three-container');
            if (!container) return;
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 25; // Adjusted camera distance

            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            // PERFORMANCE FIX: Cap pixel ratio to 1 to reduce GPU load on high-DPI screens
            renderer.setPixelRatio(1);
            container.appendChild(renderer.domElement);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0x333333);
            scene.add(ambientLight);

            const sunLight = new THREE.DirectionalLight(0xffffff, 1.5);
            sunLight.position.set(50, 30, 50);
            scene.add(sunLight);

            // Texture Loader
            const loader = new THREE.TextureLoader();

            // Group to hold all celestial bodies
            const solarSystem = new THREE.Group();
            scene.add(solarSystem);

            // --- EARTH ---
            const earthGroup = new THREE.Group(); // Rotating group for Earth system
            solarSystem.add(earthGroup);

            const earthGeometry = new THREE.SphereGeometry(10, 64, 64);
            const earthMaterial = new THREE.MeshPhongMaterial({
                map: loader.load('{% static "core/textures/alien_earth_like_surface.webp" %}'),
                emissiveMap: loader.load('{% static "core/textures/alien_earth_like_clouds.webp" %}'), // Using clouds as emissive map for a glowing atmosphere effect
                emissive: new THREE.Color(0x0044ff),
                emissiveIntensity: 0.2,
                specular: new THREE.Color(0x00aaff),
                shininess: 45,
                bumpMap: loader.load('{% static "core/textures/alien_earth_like_surface.webp" %}'),
                bumpScale: 0.08
            });
            const earth = new THREE.Mesh(earthGeometry, earthMaterial);
            earthGroup.add(earth);

            // --- ATMOSPHERE GLOW ---
            const atmosGeometry = new THREE.SphereGeometry(10.3, 64, 64);
            const atmosMaterial = new THREE.MeshPhongMaterial({
                color: 0x0088ff,
                transparent: true,
                opacity: 0.15,
                side: THREE.BackSide,
                blending: THREE.AdditiveBlending,
            });
            const atmosphere = new THREE.Mesh(atmosGeometry, atmosMaterial);
            earthGroup.add(atmosphere);

            // Earth Clouds
            const cloudGeometry = new THREE.SphereGeometry(10.1, 64, 64);
            const cloudMaterial = new THREE.MeshPhongMaterial({
                map: loader.load('{% static "core/textures/alien_earth_like_clouds.webp" %}'),
                transparent: true,
                opacity: 0.5,
                blending: THREE.AdditiveBlending,
                side: THREE.DoubleSide
            });
            const clouds = new THREE.Mesh(cloudGeometry, cloudMaterial);
            earthGroup.add(clouds);

            // Second Cloud Layer (Higher, faster)
            const cloud2Geometry = new THREE.SphereGeometry(10.25, 64, 64);
            const cloud2Material = new THREE.MeshPhongMaterial({
                map: loader.load('{% static "core/textures/alien_earth_like_clouds.webp" %}'),
                transparent: true,
                opacity: 0.3,
                blending: THREE.AdditiveBlending,
                side: THREE.DoubleSide
            });
            const clouds2 = new THREE.Mesh(cloud2Geometry, cloud2Material);
            clouds2.rotation.y = 1.5; // Offset
            earthGroup.add(clouds2);

            // --- ORBITING SHIPS (COMPLEX PROCEDURAL) ---
            const shipsGroup = new THREE.Group();
            earthGroup.add(shipsGroup);

            // Function to create a sci-fi ship mesh
            const createSciFiShip = () => {
                const ship = new THREE.Group();

                // Fuselage
                const fuselageGeom = new THREE.CylinderGeometry(0.05, 0.05, 0.6, 8);
                const fuselageMat = new THREE.MeshPhongMaterial({ color: 0x888888, specular: 0xffffff });
                const fuselage = new THREE.Mesh(fuselageGeom, fuselageMat);
                fuselage.rotation.x = Math.PI / 2;
                ship.add(fuselage);

                // Wings
                const wingGeom = new THREE.BoxGeometry(0.4, 0.02, 0.2);
                const wingMat = new THREE.MeshPhongMaterial({ color: 0x333333 });
                const wings = new THREE.Mesh(wingGeom, wingMat);
                wings.position.set(0, 0, 0);
                ship.add(wings);

                // Engine Glow
                const engineGeom = new THREE.SphereGeometry(0.06, 8, 8);
                const engineMat = new THREE.MeshBasicMaterial({ color: 0x00ffff });
                const engine = new THREE.Mesh(engineGeom, engineMat);
                engine.position.z = 0.3; // Behind
                ship.add(engine);

                // Engine Light
                const light = new THREE.PointLight(0x00ffff, 1, 2);
                light.position.set(0, 0, 0.35);
                ship.add(light);

                return ship;
            };

            for (let i = 0; i < 15; i++) {
                const ship = createSciFiShip();
                const distance = 13 + Math.random() * 6;
                const angle = Math.random() * Math.PI * 2;
                const height = (Math.random() - 0.5) * 12;

                ship.position.set(
                    Math.cos(angle) * distance,
                    height,
                    Math.sin(angle) * distance
                );

                ship.userData = {
                    distance: distance,
                    angle: angle,
                    speed: 0.002 + Math.random() * 0.005,
                    height: height,
                    orbitTilt: (Math.random() - 0.5) * 0.5
                };

                // Initial rotation setup
                ship.lookAt(0, 0, 0);
                shipsGroup.add(ship);
            }



            // --- MOON ---
            const moonGroup = new THREE.Group(); // Pivot for Moon orbit
            earthGroup.add(moonGroup);

            const moonGeometry = new THREE.SphereGeometry(2, 32, 32);
            const moonMaterial = new THREE.MeshPhongMaterial({
                map: loader.load('{% static "core/textures/moon_map.webp" %}'),
                shininess: 0
            });
            const moon = new THREE.Mesh(moonGeometry, moonMaterial);
            moon.position.set(20, 5, -10); // Orbit radius relative to Earth
            moonGroup.add(moon);

            // --- MARS ---
            // Mars is independent, larger orbit in background
            const marsGeometry = new THREE.SphereGeometry(4, 32, 32);
            const marsMaterial = new THREE.MeshPhongMaterial({
                map: loader.load('{% static "core/textures/mars_map.webp" %}'),
                shininess: 5
            });
            const mars = new THREE.Mesh(marsGeometry, marsMaterial);
            mars.position.set(-30, 15, -40); // Far background
            solarSystem.add(mars);


            // --- STARS / PARTICLES ---
            const particlesGeom = new THREE.BufferGeometry();
            const posArray = new Float32Array(1500 * 3);
            for (let i = 0; i < 1500 * 3; i++) posArray[i] = (Math.random() - 0.5) * 200;
            particlesGeom.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            const particlesMesh = new THREE.Points(particlesGeom, new THREE.PointsMaterial({ size: 0.1, color: 0xffffff, transparent: true, opacity: 0.6 }));
            scene.add(particlesMesh);

            let mouseX = 0, mouseY = 0;
            document.addEventListener('mousemove', (e) => {
                mouseX = (e.clientX - window.innerWidth / 2) / window.innerWidth; // -0.5 to 0.5
                mouseY = (e.clientY - window.innerHeight / 2) / window.innerHeight;
            });

            let isAnimating = true;
            let animationId;

            const animate = () => {
                if (!isAnimating) return;

                animationId = requestAnimationFrame(animate);

                // Rotations
                earth.rotation.y += 0.0005; // Slower Earth spin
                clouds.rotation.y += 0.0008; // Clouds spin
                clouds2.rotation.y += 0.0012; // Clouds2 spin faster

                // Animate Ships
                shipsGroup.children.forEach(ship => {
                    ship.userData.angle += ship.userData.speed;

                    // Complex orbit path
                    const x = Math.cos(ship.userData.angle) * ship.userData.distance;
                    const z = Math.sin(ship.userData.angle) * ship.userData.distance;
                    const y = ship.userData.height + Math.sin(ship.userData.angle * 2) * 2; // Wobbly orbit

                    ship.position.set(x, y, z);

                    // Orient ship to face movement direction
                    const nextX = Math.cos(ship.userData.angle + 0.1) * ship.userData.distance;
                    const nextZ = Math.sin(ship.userData.angle + 0.1) * ship.userData.distance;
                    const nextY = ship.userData.height + Math.sin((ship.userData.angle + 0.1) * 2) * 2;
                    ship.lookAt(nextX, nextY, nextZ);

                    ship.rotation.z += 0.02; // Banking effect
                });



                // Moon Orbit (rotate the pivot group)
                moonGroup.rotation.y += 0.0005;
                moon.rotation.y += 0.002; // Moon spins on axis

                // Mars
                mars.rotation.y += 0.0008;

                // Interactive tilt based on mouse
                solarSystem.rotation.y = mouseX * 0.2;
                solarSystem.rotation.x = mouseY * 0.2;

                particlesMesh.rotation.y = -mouseX * 0.05;

                renderer.render(scene, camera);
            };

            // PERFORMANCE FIX: Intersection Observer to pause animation when not visible
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        if (!isAnimating) {
                            isAnimating = true;
                            animate();
                        }
                    } else {
                        isAnimating = false;
                        if (animationId) cancelAnimationFrame(animationId);
                    }
                });
            }, { threshold: 0 });

            observer.observe(container);

            // Start animation initially
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        };

        // --- CURSOR SYSTEM ---
        const initCursorSystem = () => {
            const cursor = document.getElementById('cursor-ship');
            const trailCanvas = document.getElementById('trail-canvas');
            const ctx = trailCanvas.getContext('2d');
            let trail = [];
            let mouse = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
            const resizeTrail = () => { trailCanvas.width = window.innerWidth; trailCanvas.height = window.innerHeight; };
            window.addEventListener('resize', resizeTrail); resizeTrail();
            document.addEventListener('mousemove', (e) => {
                mouse.x = e.clientX; mouse.y = e.clientY;
                cursor.style.left = `${mouse.x}px`;
                cursor.style.top = `${mouse.y}px`;
                cursor.style.transform = `translate(-50%, -50%) rotate(${e.movementX * 2}deg) rotateX(${e.movementY}deg)`;
            });
            const animateTrail = () => {
                trail.push({ x: mouse.x, y: mouse.y });
                if (trail.length > 30) trail.shift();
                ctx.clearRect(0, 0, trailCanvas.width, trailCanvas.height);
                if (trail.length > 1) {
                    ctx.beginPath();
                    ctx.moveTo(trail[0].x, trail[0].y);
                    for (let i = 1; i < trail.length; i++) ctx.lineTo(trail[i].x, trail[i].y);
                    const gradient = ctx.createLinearGradient(trail[0].x, trail[0].y, trail[trail.length - 1].x, trail[trail.length - 1].y);
                    gradient.addColorStop(0, 'rgba(0, 255, 65, 0)');
                    gradient.addColorStop(1, 'rgba(0, 255, 65, 0.5)');
                    ctx.lineWidth = 4; ctx.strokeStyle = gradient; ctx.lineCap = 'round'; ctx.stroke();
                }
                requestAnimationFrame(animateTrail);
            };
            animateTrail();
        };



        // --- MOBILE MENU LOGIC ---
        const mobileBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');

        mobileBtn.addEventListener('click', () => {
            mobileMenu.classList.remove('translate-x-full');
            document.body.style.overflow = 'hidden'; // Lock scroll
        });

        function closeMobileMenu() {
            mobileMenu.classList.add('translate-x-full');
            document.body.style.overflow = ''; // Unlock scroll
        }

        function toggleMobileSubmenu(id) {
            const el = document.getElementById(id);
            if (el.classList.contains('open')) {
                el.classList.remove('open');
            } else {
                // Close others if needed
                document.querySelectorAll('.mobile-submenu').forEach(s => s.classList.remove('open'));
                el.classList.add('open');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initThreeJS();
            initCursorSystem();

            // --- DECRYPT EFFECT ---
            const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%^&*";
            document.querySelectorAll(".decrypt-effect").forEach(el => {
                el.addEventListener('mouseover', () => {
                    let iteration = 0; const original = el.dataset.value || el.innerText;
                    const interval = setInterval(() => {
                        el.innerText = original.split("").map((l, i) => i < iteration ? original[i] : letters[Math.floor(Math.random() * letters.length)]).join("");
                        if (iteration >= original.length) clearInterval(interval);
                        iteration += 1 / 3;
                    }, 30);
                });
            });
        });
    </script>
    <script src="https://unpkg.com/@studio-freight/lenis@1.0.42/dist/lenis.min.js"></script>
    <script>
        // Initialize Lenis
        const lenis = new Lenis({
            duration: 1.2,
            easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)), // https://www.desmos.com/calculator/brs54l4xou
            direction: 'vertical', // vertical, horizontal
            gestureDirection: 'vertical', // vertical, horizontal, both
            smooth: true,
            mouseMultiplier: 1,
            smoothTouch: false,
            touchMultiplier: 2,
        })

        function raf(time) {
            lenis.raf(time)
            requestAnimationFrame(raf)
        }

        requestAnimationFrame(raf)

        // Handle Anchor Links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const targetId = this.getAttribute('href');
                if (targetId && targetId !== '#') {
                    lenis.scrollTo(targetId);
                }
            });
        });
    </script>


    {% block extra_scripts %}{% endblock %}
</body>

</html>